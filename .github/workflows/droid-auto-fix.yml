name: Droid Auto-Fix Issues
on:
  issues:
    types: [opened, labeled]

jobs:
  fix-issue:
    if: contains(github.event.issue.labels.*.name, 'droid')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Droid CLI
        run: |
          curl -fsSL https://app.factory.ai/cli | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Analyze and fix issue
        env:
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY=$(cat <<'ISSUE_EOF'
          ${{ github.event.issue.body }}
          ISSUE_EOF
          )

          # Step 1: Analyze - is this a real bug or user error?
          droid exec --auto low -o json "
          Analyze this issue report for the codebase:
          Title: ${ISSUE_TITLE}
          Description: ${ISSUE_BODY}

          Investigate the codebase and determine:
          1. Is this a real bug in the code?
          2. Is this user error or misconfiguration?
          3. Is this expected behavior?
          4. Is there not enough information to determine?

          Write your verdict to analysis.json with this exact format:
          {
            \"verdict\": \"bug\" or \"user_error\" or \"expected_behavior\" or \"needs_info\",
            \"explanation\": \"clear explanation of your finding\"
          }
          " > /dev/null 2>&1

          if [ ! -f analysis.json ]; then
            echo '{"verdict":"bug","explanation":"Could not complete analysis, attempting fix."}' > analysis.json
          fi

          VERDICT=$(cat analysis.json | python3 -c "import sys,json; print(json.load(sys.stdin).get('verdict','bug'))" 2>/dev/null || echo "bug")
          EXPLANATION=$(cat analysis.json | python3 -c "import sys,json; print(json.load(sys.stdin).get('explanation',''))" 2>/dev/null || echo "")

          # Step 2: Handle based on verdict
          case "$VERDICT" in
            user_error)
              gh issue comment "$ISSUE_NUMBER" \
                --body "## Analysis: User Error

          ${EXPLANATION}

          This doesn't appear to be a bug in the code. If you believe this is incorrect, please provide more details and reopen."
              gh issue close "$ISSUE_NUMBER"
              gh issue edit "$ISSUE_NUMBER" --add-label "wontfix"
              exit 0
              ;;

            expected_behavior)
              gh issue comment "$ISSUE_NUMBER" \
                --body "## Analysis: Expected Behavior

          ${EXPLANATION}

          This is working as intended. If you'd like this behavior changed, please open a feature request instead."
              gh issue close "$ISSUE_NUMBER"
              gh issue edit "$ISSUE_NUMBER" --add-label "wontfix"
              exit 0
              ;;

            needs_info)
              gh issue comment "$ISSUE_NUMBER" \
                --body "## Analysis: More Information Needed

          ${EXPLANATION}

          Could you provide more details so I can investigate further? Once updated, add the \`droid\` label again to retrigger."
              gh issue edit "$ISSUE_NUMBER" --add-label "needs-info"
              gh issue edit "$ISSUE_NUMBER" --remove-label "droid"
              exit 0
              ;;

            bug|*)
              # Continue to fix
              ;;
          esac

          # Step 3: Fix the bug
          BRANCH="droid/fix-issue-${ISSUE_NUMBER}"
          git checkout -b "$BRANCH"

          droid exec --auto high "
          You are working on issue #${ISSUE_NUMBER}.
          Title: ${ISSUE_TITLE}
          Description: ${ISSUE_BODY}
          Analysis: ${EXPLANATION}

          This has been confirmed as a real bug. Fix it:
          1. Implement the fix
          2. Make sure the code compiles/runs correctly
          3. Run any existing tests to verify nothing is broken
          4. Do NOT commit - the workflow handles that
          "

          # Step 4: Create PR or report failure
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "fix: resolve issue #${ISSUE_NUMBER} - ${ISSUE_TITLE}

            Co-authored-by: factory-droid[bot] <138933559+factory-droid[bot]@users.noreply.github.com>"
            git push origin "$BRANCH"

            gh pr create \
              --title "fix: resolve issue #${ISSUE_NUMBER} - ${ISSUE_TITLE}" \
              --body "## Automated fix for #${ISSUE_NUMBER}

          ### Analysis
          ${EXPLANATION}

          ### What was done
          Droid confirmed this is a bug and implemented a fix.
          Please review the changes before merging." \
              --base main \
              --head "$BRANCH"

            gh issue comment "$ISSUE_NUMBER" \
              --body "## Bug Confirmed & Fix Ready

          ${EXPLANATION}

          I've created a PR with a fix. Please review and merge when ready."
          else
            gh issue comment "$ISSUE_NUMBER" \
              --body "## Bug Confirmed but Fix Failed

          ${EXPLANATION}

          I confirmed this is a bug but couldn't produce a working fix. A human should take a look."
            gh issue edit "$ISSUE_NUMBER" --add-label "help-wanted"
          fi
