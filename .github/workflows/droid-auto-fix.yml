name: Droid Auto-Fix Issues
on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

jobs:
  fix-issue:
    if: >
      (github.event_name == 'issues') ||
      (github.event_name == 'issue_comment' && !contains(github.event.comment.user.login, '[bot]'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Droid CLI
        run: |
          curl -fsSL https://app.factory.ai/cli | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Analyze and fix issue
        env:
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine issue number and content based on event type
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY=$(cat <<'ISSUE_EOF'
          ${{ github.event.issue.body }}
          ISSUE_EOF
            )
            COMMENT_BODY=$(cat <<'COMMENT_EOF'
          ${{ github.event.comment.body }}
          COMMENT_EOF
            )
            CONTEXT="Original issue: ${ISSUE_TITLE}
          ${ISSUE_BODY}

          New comment/update from user:
          ${COMMENT_BODY}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY=$(cat <<'ISSUE_EOF'
          ${{ github.event.issue.body }}
          ISSUE_EOF
            )
            CONTEXT="Title: ${ISSUE_TITLE}
          Description: ${ISSUE_BODY}"
          fi

          # Step 1: Analyze - is this a real bug or user error?
          droid exec --auto low -o json "
          Analyze this issue report for the codebase:
          ${CONTEXT}

          Investigate the codebase and determine:
          1. Is this a real bug in the code?
          2. Is this user error or misconfiguration?
          3. Is this expected behavior?
          4. Is this a feature request?
          5. Is there not enough information to determine?

          Write your verdict to analysis.json with this exact format:
          {
            \"verdict\": \"bug\" or \"user_error\" or \"expected_behavior\" or \"feature_request\" or \"needs_info\",
            \"explanation\": \"clear explanation of your finding\"
          }
          " > /dev/null 2>&1

          if [ ! -f analysis.json ]; then
            echo '{"verdict":"bug","explanation":"Could not complete analysis, attempting fix."}' > analysis.json
          fi

          VERDICT=$(cat analysis.json | python3 -c "import sys,json; print(json.load(sys.stdin).get('verdict','bug'))" 2>/dev/null || echo "bug")
          EXPLANATION=$(cat analysis.json | python3 -c "import sys,json; print(json.load(sys.stdin).get('explanation',''))" 2>/dev/null || echo "")

          # Step 2: Handle based on verdict
          case "$VERDICT" in
            user_error)
              gh issue comment "$ISSUE_NUMBER" \
                --body "## Analysis: User Error

          ${EXPLANATION}

          This doesn't appear to be a bug in the code. If you believe this is incorrect, reopen the issue with more details."
              gh issue close "$ISSUE_NUMBER"
              exit 0
              ;;

            expected_behavior)
              gh issue comment "$ISSUE_NUMBER" \
                --body "## Analysis: Expected Behavior

          ${EXPLANATION}

          This is working as intended. If you'd like this behavior changed, reopen with a feature request."
              gh issue close "$ISSUE_NUMBER"
              exit 0
              ;;

            feature_request)
              gh issue comment "$ISSUE_NUMBER" \
                --body "## Analysis: Feature Request

          ${EXPLANATION}

          This is a feature request, not a bug. I'll attempt to implement it."
              ;;

            needs_info)
              gh issue comment "$ISSUE_NUMBER" \
                --body "## Analysis: More Information Needed

          ${EXPLANATION}

          Could you provide more details? Specifically:
          1. What behavior did you expect?
          2. What actually happened?
          3. Steps to reproduce the problem.

          Reply to this issue and I'll re-analyze automatically."
              gh issue edit "$ISSUE_NUMBER" --add-label "needs-info"
              exit 0
              ;;

            bug|*)
              # Continue to fix
              ;;
          esac

          # Step 3: Fix the bug / implement the feature
          BRANCH="droid/fix-issue-${ISSUE_NUMBER}"

          # Check if branch already exists (from a previous attempt)
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            git merge main --no-edit || true
          else
            git checkout -b "$BRANCH"
          fi

          droid exec --auto high "
          You are working on issue #${ISSUE_NUMBER}.
          ${CONTEXT}
          Analysis: ${EXPLANATION}

          Fix this issue:
          1. Implement the fix or feature
          2. Make sure the code compiles/runs correctly
          3. Run any existing tests to verify nothing is broken
          4. Do NOT commit - the workflow handles that
          "

          # Step 4: Create PR or report failure
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "fix: resolve issue #${ISSUE_NUMBER} - ${ISSUE_TITLE}

            Co-authored-by: factory-droid[bot] <138933559+factory-droid[bot]@users.noreply.github.com>"
            git push origin "$BRANCH"

            # Only create PR if one doesn't exist yet
            EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")
            if [ -z "$EXISTING_PR" ]; then
              gh pr create \
                --title "fix: resolve issue #${ISSUE_NUMBER} - ${ISSUE_TITLE}" \
                --body "## Automated fix for #${ISSUE_NUMBER}

          ### Analysis
          ${EXPLANATION}

          ### What was done
          Droid analyzed and implemented a fix for this issue.
          Please review the changes before merging." \
                --base main \
                --head "$BRANCH"

              gh issue comment "$ISSUE_NUMBER" \
                --body "## Fix Ready

          ${EXPLANATION}

          I've created a PR with a fix. Please review and merge. Closing this issue -- reopen if the fix isn't satisfactory."
              gh issue close "$ISSUE_NUMBER"
            else
              gh issue comment "$ISSUE_NUMBER" \
                --body "## PR Updated

          I've pushed additional changes to PR #${EXISTING_PR} based on the latest feedback. Closing this issue -- reopen if needed."
              gh issue close "$ISSUE_NUMBER"
            fi
          else
            gh issue comment "$ISSUE_NUMBER" \
              --body "## Could Not Fix

          ${EXPLANATION}

          I analyzed this but couldn't produce a working fix. A human should take a look."
            gh issue edit "$ISSUE_NUMBER" --add-label "help-wanted"
          fi
